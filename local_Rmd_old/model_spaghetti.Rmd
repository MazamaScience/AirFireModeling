---
title: "model_spaghetti"
author: "Mazama Science"
date: "11/6/2019"
output: html_document
params:
  longitude: -120.591
  latitude: 38.714
  datetime: "20191012"
  radius: 20000
  count: 5
---

<!--
Berkeley Aquatic park
monitor_loadLatest() %>% monitor_subset(monitorIDs = "060010013_01") %>% monitor_extractMeta() %>% str()
-->

## Setup

Creating fake monitors to mimic the "Pollock Pines Environment Ed" monitor
from Oct 10-14, 2019.

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(PWFSLSmoke)
initializeMazamaSpatialUtils()
  
library(AirFireModeling)
setModelDataDir('~/Data/BlueSky')

library(AirMonitorPlots)

# Set up logging
MazamaCoreUtils::logger.setup()
MazamaCoreUtils::logger.setLevel("ERROR")

# Handle parameters
longitude <- params$longitude
latitude <- params$latitude
radius <- params$radius
count <- params$count

if ( params$datetime == "NOW" ) {
  datetime <- lubridate::now("UTC")
} else {
  datetime <- MazamaCoreUtils::parseDatetime(params$datetime, "UTC")
}
```

## Monitoring data

```{r pollock_pines, echo = FALSE}
pollock_pines <- 
  monitor_load(20191010, 20191014) %>% 
  monitor_subset(monitorIDs = "lon_.120.591_lat_38.714_arb2.1008")

gg <- ggplot_pm25Timeseries(pollock_pines) +
  geom_pm25Points() + 
  stat_nowcast() +
  theme(legend.position = "bottom") +
  ggtitle("Pollock Pines monitor")

print(gg)
```


```{r download_models, echo = FALSE}
# Find temporal overlap
modelRuns <- 
  MazamaCoreUtils::dateSequence(
    datetime - lubridate::days(2),
    datetime,
    timezone = "UTC"
  ) %>%
  MazamaCoreUtils::timeStamp(style = "ymdhms", unit = "hour", timezone = "UTC")
```

Using the following model initialization times: `r paste0(modelRuns, collapse=", ")`

```{r available_models, echo = FALSE}
# Find spatial overlap
models <- 
  AirFireModeling::bluesky_availiableModels(params$longitude, params$latitude)
```

Using the following models `r paste0(models, collapse=", ")`

## Model Links 

### `r modelRuns[1]`
`r paste0('[', models, ']', '(https://tools.airfire.org/websky/v1/run/standard/', models,'/', modelRuns[1], '00', ')')`

### `r modelRuns[2]`
`r paste0('[', models, ']', '(https://tools.airfire.org/websky/v1/run/standard/', models,'/', modelRuns[2], '00', ')')`

### `r modelRuns[3]`
`r paste0('[', models, ']', '(https://tools.airfire.org/websky/v1/run/standard/', models,'/', modelRuns[3], '00', ')')`


## Use `r count` grid cells from each model to create "fake" monitors

```{r load_models, echo = FALSE}
# Limit data load
# 111320 m per deg at the equator 
halfWidth <- radius / 111320
xlim <- c(longitude - 2*halfWidth, longitude + 2*halfWidth)
ylim <- c(latitude - 2*halfWidth, latitude + 2*halfWidth)

# Loop over models and modelRuns to create gridList and fakeMonitorList
gridList <- list()
fakeMonitorList <- list()
for ( model in models ) {
  for ( modelRun in modelRuns ) {
    
    # Load model data
    name <- paste0(model, '_', modelRun)
    print(name)
    
    result <- try({
      gridList[[name]] <-
        AirFireModeling::bluesky_load(
          model = model,
          modelRun = modelRun,
          subDir = 'forecast',
          xlim = xlim,
          ylim = ylim
        )
    }, silent = FALSE)
    
    if ( "try-error" %in% class(result) ) {
      
      gridList[[name]] <- NULL
      fakeMonitorList[[name]] <- NULL
      
    } else {
      
      result <- try({
        # Create a ws_monitor object with 'count' timeseries
        fakeMonitorList[[name]] <- 
          AirFireModeling::grid_createMonitor(
            gridList[[name]],
            longitude = longitude,
            latitude = latitude,
            radius = radius,
            count = count,
            monitorID = name
          )
     
        # Add model and modelRun to metadata
        fakeMonitorList[[name]]$meta$model <- 
          ifelse(stringr::str_count(model) > 15,
                 paste0(stringr::str_sub(model,1,15),"..."),
                 model)
        fakeMonitorList[[name]]$meta$modelRun <- modelRun
      })
      
      if ( "try-error" %in% class(result) ) {
        fakeMonitorList[[name]] <- NULL
      }
      
    }
    
    
  } # END of modelRun loop
} # END of model loop

# Create a single ws_monitor object
fakeMonitors <- monitor_combine(fakeMonitorList)
```


## "Fake" monitor timeseries

```{r timeseries_by_model, echo = FALSE, warning = FALSE, fig.height = 8}
# tlim
tlim <- MazamaCoreUtils::dateRange(
  datetime - lubridate::ddays(2),
  datetime + lubridate::ddays(3),
  timezone = "UTC"
)

monitor_subset <- monitor_subset(fakeMonitors, tlim = tlim)

gg <- 
  ggplot_pm25Timeseries(
    monitor_subset,
    ylim = c(0, max(monitor_subset$data[,-1], na.rm = TRUE))
  ) +
  geom_pm25Points(aes(color = modelRun)) + 
  stat_nowcast(aes(color = modelRun)) +
  facet_grid(rows = vars(model)) +
  theme(legend.position="right") +
  theme(legend.position = "bottom") +
  ggtitle("By Model")

print(gg)
```


```{r timeseries_by_modelrun, echo = FALSE, warning = FALSE, fig.height = 8}
# tlim
# tlim
tlim <- MazamaCoreUtils::dateRange(
  datetime - lubridate::ddays(2),
  datetime + lubridate::ddays(3),
  timezone = "UTC"
)

monitor_subset <- monitor_subset(fakeMonitors, tlim = tlim)

gg <- 
  ggplot_pm25Timeseries(
    monitor_subset,
    startdate = tlim[1],
    enddate = tlim[2],
    ylim = c(0, max(monitor_subset$data[,-1], na.rm = TRUE))
  ) +
  geom_pm25Points(aes(color = model)) + 
  stat_nowcast(aes(color = model)) +
  facet_grid(rows = vars(modelRun)) +
  theme(legend.position="right") +
  theme(legend.position = "bottom") +
  ggtitle("By Model Initialization")

print(gg)
```




