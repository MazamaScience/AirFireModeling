---
title: "LandScan Data"
author: "Mazama Science"
date: "2020-04-06"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{LandScan Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  warning = FALSE,
  message = FALSE,
  fig.width = 7, 
  fig.height = 5
)
```

This vignette demonstrates how to create county averages from BlueSky model runs.
This is particularly relevant in the COVID-19 era where health statistics are
provided on a per-county basis.

### Spatial data setup

The *MazamaSpatialUtils* package is already a requirement for *AirFireModeling* 
and is therefore already installed. We will use datasets named
`USCensusStates` and `USCensusCounties`. Each of these is a
`SpatialPolygonsDataFrame` (SPDF). These are "S4" objects with per-polygon data 
stored in the `@data` slot.

```{r MazamaSpatialUtils}
library("MazamaSpatialUtils")
setSpatialDataDir("~/Data/Spatial")

loadSpatialData("USCensusStates")
loadSpatialData("USCensusCounties")

stateCodes <- c("CA", "NV")

state_SPDF <- subset(USCensusStates, stateCode %in% stateCodes)
county_SPDF <- subset(USCensusCounties, stateCode %in% stateCodes)
```

### Load BlueSky data

The `modelBrick` object is a "RasterBrick" with 72 layers.

```{r load_bluesky}
library(AirFireModeling) # For base package support
setModelDataDir("~/Data/BlueSky")

modelBrick <- 
  bluesky_load(model = 'CANSAC-1.33km', modelRun = 2020041100) %>%
  raster::crop(state_SPDF)
```

### Load LandScan data

LandScan population data is loaded as a single-layer "RasterLayer".

```{r load_LandScan}
population <- raster::raster(path.expand("~/Data/RasterLayers/LandScanConusNight_cansac_1_33.nc"))
```

### Thematic mapping with tmap

The **tmap** package is a brilliantly simple way to make attractive plots using
both raster and spatial data. It is thoroughly described at
[Intro to GIS and Spatial Analysis](https://mgimond.github.io/Spatial/).

Creating a nice looking plot is very straightforward:

```{r tmap_demo}
library(tmap)

# Replace low values with NA to get transparency
m1 <- modelBrick[[3]]
m1_na <- m1
m1_na[m1 < 1] <- NA

p1 <- population / 1000
p1_na <- p1
p1_na[p1 < .1] <- NA

# County boundaries with raster overlay
tm_shape(county_SPDF) +
  tm_polygons(
    alpha = 0,
    border.col = adjustcolor('black', alpha = 0.4)
  ) +
  tm_shape(m1_na) +
  tm_raster(
    title = "Model PM2.5",
    colorNA = NULL,
    palette = 'Greys',
    alpha = 0.7,
    breaks = c(0, 5, 10, 20, 50, 100, 350, Inf)
    ###style = "log10_pretty"
  ) +
  tm_layout(
    title = "Predicted Smoke"
  ) +
  tm_shape(p1_na) +
  tm_raster(
    title = "Population (thousands)",
    palette = 'Reds',
    colorNA = NULL,
    alpha = 0.5,
    breaks = c(0, 1, 2, 5, 10, 20, 50, Inf)
    ###style = "log10_pretty"
  ) +
  tm_legend(outside = TRUE)

```

### Intersecting layers

Test to see if our rasters are on the same grid

```{r test_same_grid}
print(m1)
print(p1)
```

In our case, the grids are not quite identical so we need to take care of that.
Once they are on the same grid, we can do math on them.

```{r raster_math}
# Convert p1 to the m1 grid
p2 <- raster::resample(p1, m1, method = "bilinear")

# Person-exposure per grid cell per hour
exposure <- p2 * m1
# Now "smear it out" a little
f1 <- raster::focal(
  exposure, 
  w = matrix(1, nrow = 3, ncol = 3), 
  fun = mean, 
  pad = TRUE,  
  na.rm = TRUE
)
f1_na <- f1
f1_na[f1_na < .01] <- NA

tm_shape(county_SPDF) +
  tm_polygons(
    alpha = 0,
    border.col = adjustcolor('black', alpha = 0.4)
  ) +
  tm_shape(f1_na) +
  tm_raster(
    title = "PM2.5",
    palette = 'YlOrBr',
    # To make it more dramatic
    breaks = c(0, 10, 20, 50, 100, 200, 500, Inf)
  ) +
  tm_layout(
    title = "Thousand-person Exposure"
  ) +
  tm_legend(outside = TRUE)
 
```

### Summarizing data



```{r countyExposure}
# Summarize a single RasterLayer by polygon
countyExposure_SPDF <-
  raster::extract(
    f1_na,
    county_SPDF,
    fun = function(x, ...) { mean(x, ...) },
    na.rm = TRUE,
    sp = TRUE
  )

# Replace newly added column name associated with this layer
names(countyExposure_SPDF) <- c(names(county_SPDF), "exposure")

# Simple plot
tm_shape(countyExposure_SPDF) + 
  tm_polygons(
    title = "PM2.5",
    col = "exposure",
    #colorNA = NULL,
    ###breaks = c(0, 1, 2, 5, 10, 20, 50, Inf),
    style = "log10_pretty",
    border.col = adjustcolor('black', alpha = 0.4)
  ) +
    tm_layout(
    title = "Thousand-person Exposure"
  ) +
  tm_legend(outside = TRUE)

```

### Adding county COVID-19 data

With COVID-19 data available by county, weighting things by COVID-19 statistics
would be equally straightforward.

### Adding monitoringn data

The **tmap** package provides functions for working with point data as well so 
monitoring data available from **PWFSLSmoke** could be added as well.

