<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Receptor Analysis • AirFireModeling</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Receptor Analysis">
<meta property="og:description" content="AirFireModeling">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">AirFireModeling</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/AirFireModeling_Introduction.html">Introduction to AirFireModeling</a>
    </li>
    <li>
      <a href="../../articles/articles/Aggregation_by_Polygon.html">Aggregation by Polygon</a>
    </li>
    <li>
      <a href="../../articles/articles/Lazy_Evaluation.html">Lazy Evaluation</a>
    </li>
    <li>
      <a href="../../articles/articles/Receptor_Analysis.html">Receptor Analysis</a>
    </li>
    <li>
      <a href="../../articles/articles/Smoke_by_County.html">Smoke by County</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Receptor_Analysis_files/header-attrs-2.5/header-attrs.js"></script><link href="Receptor_Analysis_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="Receptor_Analysis_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Receptor Analysis</h1>
                        <h4 class="author">Mazama Science</h4>
            
            <h4 class="date">2021-03-12</h4>
      
      
      <div class="hidden name"><code>Receptor_Analysis.Rmd</code></div>

    </div>

    
    
<p>This vignette explains how “receptor analysis” reports are generated. These reports gather and visualize PM 2.5 readings for a given location using BlueSky model output.</p>
<div id="report-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#report-parameters" class="anchor"></a>Report Parameters</h2>
<p>Before anything else, a report must gather all the details about the analysis being requested. These are provided in the <code>infoList</code>, <code>dataList</code>, and <code>textList</code> parameters, which hold useful information like the coordinates of the target location, start/end dates, and the sample radius around the location.</p>
</div>
<div id="header-map" class="section level2">
<h2 class="hasAnchor">
<a href="#header-map" class="anchor"></a>Header &amp; Map</h2>
<p>The report header displays the time the report was requested as well as the versions of the packages it uses: <strong>PWFSLSmoke</strong> and <strong>AirFireModeling</strong>. This information is gathered using <code><a href="http://lubridate.tidyverse.org/reference/now.html">lubridate::now()</a></code> and <code><a href="https://rdrr.io/r/utils/packageDescription.html">utils::packageVersion()</a></code>.</p>
<p>For example:</p>
<ul>
<li><p><code><a href="http://lubridate.tidyverse.org/reference/now.html">lubridate::now()</a></code>: 2021-03-12 12:45:09</p></li>
<li><p><code><a href="https://rdrr.io/r/utils/packageDescription.html">utils::packageVersion("AirFireModeling")</a></code>: 0.3.3</p></li>
</ul>
<p>A simple Leaflet map is displayed under the header with a marker at the location of interest.</p>
</div>
<div id="monitoring-data" class="section level2">
<h2 class="hasAnchor">
<a href="#monitoring-data" class="anchor"></a>Monitoring Data</h2>
<p>Sometimes a user might provide an existing air monitor ID as a parameter. When this is the case, the timeseries readings for that monitor will be plotted below the Leaflet map.</p>
</div>
<div id="latest-available-models" class="section level2">
<h2 class="hasAnchor">
<a href="#latest-available-models" class="anchor"></a>Latest Available Models</h2>
<p>Now the PM 2.5 readings around the target location will be gathered. The first step towards this is to determine which BlueSky models have a domain covering that particular location. The <strong>AirFireModeling</strong> package provides an easy way to do this with the <code><a href="../../reference/bluesky_findModels.html">bluesky_findModels()</a></code> function, which takes in longitude and latitude coordinates (in this case: -122.68, 45.52) and returns a list of the models that cover them.</p>
<p>Reports are further limited to only using a small subset of these models:</p>
<ul>
<li>PNW-4km</li>
<li>PNW-1.33km</li>
<li>CANSAC-4km</li>
<li>CANSAC-1.33km</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AirFireModeling</span><span class="op">)</span>
<span class="fu"><a href="../../reference/setModelDataDir.html">setModelDataDir</a></span><span class="op">(</span><span class="st">'~/Data/BlueSky'</span><span class="op">)</span>

<span class="co"># Available models</span>
<span class="va">allowedModels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="st">"PNW-4km"</span>, <span class="st">"PNW-1.33km"</span>,
  <span class="st">"CANSAC-4km"</span>, <span class="st">"CANSAC-1.33km"</span>
<span class="op">)</span>

<span class="va">availableModels</span> <span class="op">&lt;-</span> <span class="fu">AirFireModeling</span><span class="fu">::</span><span class="fu"><a href="../../reference/bluesky_findModels.html">bluesky_findModels</a></span><span class="op">(</span>
  longitude <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">longitude</span><span class="op">)</span>,
  latitude <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">latitude</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">modelNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">intersect</a></span><span class="op">(</span><span class="va">availableModels</span>, <span class="va">allowedModels</span><span class="op">)</span></code></pre></div>
<p>With the proper models for that location, the latest two runs for each model are loaded using <code><a href="../../reference/bluesky_latestModelRun.html">bluesky_latestModelRun()</a></code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load the latest model runs</span>
<span class="va">latestModelRunList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span> <span class="va">model</span> <span class="kw">in</span> <span class="va">modelNames</span> <span class="op">)</span> <span class="op">{</span>
  <span class="va">latestModelRunList</span><span class="op">[[</span><span class="va">model</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/bluesky_latestModelRun.html">bluesky_latestModelRun</a></span><span class="op">(</span><span class="va">model</span>, <span class="fl">2</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Lastly, each of these model runs are arranged in a dataframe storing their model name, model run, and model run time.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Old school creation of a dataframe</span>
<span class="va">modelNameList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">modelRunList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="kw">for</span> <span class="op">(</span> <span class="va">name</span> <span class="kw">in</span> <span class="va">modelNames</span> <span class="op">)</span> <span class="op">{</span>
  <span class="kw">for</span> <span class="op">(</span> <span class="va">run</span> <span class="kw">in</span> <span class="va">latestModelRunList</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span> <span class="op">{</span>
    <span class="va">modelNameList</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">name</span>
    <span class="va">modelRunList</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">run</span>
    <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="va">modelName</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">modelNameList</span><span class="op">)</span><span class="op">)</span>
<span class="va">modelRun</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">modelRunList</span><span class="op">)</span><span class="op">)</span>
<span class="va">modelRunTime</span> <span class="op">&lt;-</span> <span class="fu">MazamaCoreUtils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MazamaCoreUtils/man/parseDatetime.html">parseDatetime</a></span><span class="op">(</span><span class="va">modelRun</span>, timezone <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>
<span class="va">modelRunTimeString</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strptime.html">strftime</a></span><span class="op">(</span><span class="va">modelRunTime</span>, <span class="st">"%a, %B %e at %H:00 UTC"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>
<span class="va">webskyUrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://tools.airfire.org/websky/v1/run/standard/"</span>, <span class="va">modelName</span>, <span class="st">"/"</span>, <span class="va">modelRun</span><span class="op">)</span>
<span class="va">modelNameUrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"["</span>, <span class="va">modelName</span>, <span class="st">"]("</span>, <span class="va">webskyUrl</span>, <span class="st">")"</span><span class="op">)</span>

<span class="co"># Create a dataframe for later use</span>
<span class="va">modelDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  modelName <span class="op">=</span> <span class="va">modelName</span>,
  modelRun <span class="op">=</span> <span class="va">modelRun</span>,
  modelRunTime <span class="op">=</span> <span class="va">modelRunTime</span>,
  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span></code></pre></div>
<p>This dataframe is rendered as a table with links to the model run animations on the <a href="https://www.google.com/url?q=https%3A%2F%2Ftools.airfire.org%2Fwebsky%2F&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGckuTjB3h9DCJBigyWwB49FEkryA">BlueSky Daily Run Viewer</a>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create an HTML table</span>
<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    modelNameUrl <span class="op">=</span> <span class="va">modelNameUrl</span>,
    modelRun <span class="op">=</span> <span class="va">modelRun</span>,
    modelRunTime <span class="op">=</span> <span class="va">modelRunTimeString</span>
    <span class="op">)</span>,
  col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Model"</span>, <span class="st">"Run"</span>, <span class="st">"UTC Time"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">Model</th>
<th align="left">Run</th>
<th align="left">UTC Time</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><a href="https://tools.airfire.org/websky/v1/run/standard/CANSAC-4km/2021031112">CANSAC-4km</a></td>
<td align="left">2021031112</td>
<td align="left">Thu, March 11 at 12:00 UTC</td>
</tr>
<tr class="even">
<td align="left"><a href="https://tools.airfire.org/websky/v1/run/standard/CANSAC-4km/2021031200">CANSAC-4km</a></td>
<td align="left">2021031200</td>
<td align="left">Fri, March 12 at 00:00 UTC</td>
</tr>
<tr class="odd">
<td align="left"><a href="https://tools.airfire.org/websky/v1/run/standard/PNW-4km/2021031112">PNW-4km</a></td>
<td align="left">2021031112</td>
<td align="left">Thu, March 11 at 12:00 UTC</td>
</tr>
<tr class="even">
<td align="left"><a href="https://tools.airfire.org/websky/v1/run/standard/PNW-4km/2021031200">PNW-4km</a></td>
<td align="left">2021031200</td>
<td align="left">Fri, March 12 at 00:00 UTC</td>
</tr>
<tr class="odd">
<td align="left"><a href="https://tools.airfire.org/websky/v1/run/standard/PNW-1.33km/2021031112">PNW-1.33km</a></td>
<td align="left">2021031112</td>
<td align="left">Thu, March 11 at 12:00 UTC</td>
</tr>
<tr class="even">
<td align="left"><a href="https://tools.airfire.org/websky/v1/run/standard/PNW-1.33km/2021031200">PNW-1.33km</a></td>
<td align="left">2021031200</td>
<td align="left">Fri, March 12 at 00:00 UTC</td>
</tr>
</tbody>
</table>
</div>
<div id="loading-model-runs" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-model-runs" class="anchor"></a>Loading Model Runs</h2>
<p>Once the model runs have been identified for the location, the actual data produced by those runs must be loaded.</p>
<p>Each BlueSky model covers a sizable area–from the entire continental U.S. to large portions of individual states. An analysis report, however, is only concerned with a specific location and its close surroundings. To avoid loading more data than necessary and wasting time and memory, a rectangular boundary is calculated around the target location and only the data in that area is gathered. The longitude and latitude limits of this boundary are determined by the sample radius parameter, which in this case is 10km:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Limit data load</span>
<span class="co"># 111320 m per deg at the equator </span>
<span class="va">halfWidth</span> <span class="op">&lt;-</span> <span class="va">radius</span> <span class="op">/</span> <span class="fl">111.320</span>
<span class="va">xlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">longitude</span> <span class="op">-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">halfWidth</span>, <span class="va">longitude</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">halfWidth</span><span class="op">)</span>
<span class="va">ylim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">latitude</span> <span class="op">-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">halfWidth</span>, <span class="va">latitude</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">halfWidth</span><span class="op">)</span></code></pre></div>
<p>So our boundary here around (-122.68, 45.52) is defined by the rectangle:</p>
<ul>
<li><p>Min/max longitude: -122.86, -122.50</p></li>
<li><p>Min/max latitude: 45.34, 45.70</p></li>
</ul>
<p>The previously selected model runs will be loaded in using <code><a href="../../reference/bluesky_load.html">bluesky_load()</a></code> with the <code>xlim</code> and <code>ylim</code> restrictions.</p>
</div>
<div id="conversion-to-monitor" class="section level2">
<h2 class="hasAnchor">
<a href="#conversion-to-monitor" class="anchor"></a>Conversion to Monitor</h2>
<p>Data loaded from a BlueSky model run provides a set of gridded PM 2.5 readings in the form of a <em>RasterBrick</em>. The goal of a receptor analysis report is to use this data to produce timeseries plots of PM 2.5 readings around a target location, so it is necessary to transform RasterBricks into a form that is timeseries plottable. This is can be done using the <code><a href="../../reference/raster_toMonitor.html">raster_toMonitor()</a></code> function, which creates a PWFSLSmoke <em>ws_monitor</em> object from a <em>Raster</em> object. This requires the coordinates of the target location as well as the sample radius around it and an upper limit on the number of cells that can be sampled for this ‘fake monitor’.</p>
<p>The analysis report will loop through the previously built model run dataframe to load the model runs and convert them into monitors. During this process two lists will be built:</p>
<ol style="list-style-type: decimal">
<li><p>The ‘fake monitor list’ (these aren’t real air monitors, after all), which stores the raw data readings for each monitor object.</p></li>
<li><p>The ‘fake average list’, which averages the readings across the monitors.</p></li>
</ol>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># MazamaSpatialUtils are needed to determine timezone and state</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/MazamaScience/MazamaSpatialUtils">MazamaSpatialUtils</a></span><span class="op">)</span>
<span class="fu">PWFSLSmoke</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PWFSLSmoke/man/initializeMazamaSpatialUtils.html">initializeMazamaSpatialUtils</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># PWFSLSmoke needed to average monitors</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/MazamaScience/PWFSLSmoke">PWFSLSmoke</a></span><span class="op">)</span>

<span class="co"># Loop over models and modelRuns to create gridList and fakeMonitorList</span>
<span class="va">gridList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">fakeMonitorList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">fakeAverageList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span> <span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">modelDF</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span> <span class="op">{</span>
  
  <span class="va">modelName</span> <span class="op">&lt;-</span> <span class="va">modelDF</span><span class="op">$</span><span class="va">modelName</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
  <span class="va">modelRun</span> <span class="op">&lt;-</span> <span class="va">modelDF</span><span class="op">$</span><span class="va">modelRun</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
  
  <span class="co"># Load model data using the lon/lat restrictions</span>
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">modelName</span>, <span class="st">"_"</span>, <span class="va">modelRun</span><span class="op">)</span>
  <span class="va">result</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="op">{</span>
    <span class="va">gridList</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span>
      <span class="fu">AirFireModeling</span><span class="fu">::</span><span class="fu"><a href="../../reference/bluesky_load.html">bluesky_load</a></span><span class="op">(</span>
        modelName <span class="op">=</span> <span class="va">modelName</span>,
        modelRun <span class="op">=</span> <span class="va">modelRun</span>,
        xlim <span class="op">=</span> <span class="va">xlim</span>,
        ylim <span class="op">=</span> <span class="va">ylim</span>,
        verbose <span class="op">=</span> <span class="cn">TRUE</span>
      <span class="op">)</span>
  <span class="op">}</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  
  <span class="kw">if</span> <span class="op">(</span> <span class="st">"try-error"</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">)</span> <span class="op">{</span>
    
    <span class="co"># bluesky_load() failed -- insert NULL</span>
    
    <span class="va">gridList</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
    <span class="va">fakeMonitorList</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
    <span class="va">fakeAverageList</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
    
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    
    <span class="co"># bluesky_load() succeeded -- create monitor objects</span>
    
    <span class="va">result</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="op">{</span>
      <span class="co"># Create a ws_monitor object with 'count' timeseries</span>
      <span class="va">fakeMonitorList</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span>
        <span class="fu">AirFireModeling</span><span class="fu">::</span><span class="fu"><a href="../../reference/raster_toMonitor.html">raster_toMonitor</a></span><span class="op">(</span>
          <span class="va">gridList</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span>,
          longitude <span class="op">=</span> <span class="va">longitude</span>,
          latitude <span class="op">=</span> <span class="va">latitude</span>,
          radius <span class="op">=</span> <span class="va">radius</span>,
          count <span class="op">=</span> <span class="va">count</span>,
          rasterName <span class="op">=</span> <span class="va">name</span>,
          verbose <span class="op">=</span> <span class="cn">FALSE</span>
        <span class="op">)</span>
      
      <span class="co"># Add modelName and modelRun to metadata</span>
      <span class="va">fakeMonitorList</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">meta</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span>
        <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_count.html">str_count</a></span><span class="op">(</span><span class="va">modelName</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">15</span>,
               <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">modelName</span>,<span class="fl">1</span>,<span class="fl">15</span><span class="op">)</span>, <span class="st">"..."</span><span class="op">)</span>,
               <span class="va">modelName</span><span class="op">)</span>
      <span class="va">fakeMonitorList</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">meta</span><span class="op">$</span><span class="va">modelRun</span> <span class="op">&lt;-</span> <span class="va">modelRun</span>
      
      <span class="va">fakeAverageList</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> 
        <span class="fu"><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_collapse.html">monitor_collapse</a></span><span class="op">(</span>
          <span class="va">fakeMonitorList</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span>,
          monitorID <span class="op">=</span> <span class="va">name</span>
        <span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    
    <span class="kw">if</span> <span class="op">(</span> <span class="st">"try-error"</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">)</span> <span class="op">{</span>
      <span class="va">fakeMonitorList</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
      <span class="va">fakeAverageList</span><span class="op">[[</span><span class="va">name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
    <span class="op">}</span>
    
  <span class="op">}</span>
  
<span class="op">}</span> <span class="co"># END of modelDF loop</span></code></pre></div>
</div>
<div id="timeseries-plots" class="section level2">
<h2 class="hasAnchor">
<a href="#timeseries-plots" class="anchor"></a>Timeseries Plots</h2>
<p>Finally, the timeseries plots for the monitors are generated with the <code><a href="https://rdrr.io/pkg/AirMonitorPlots/man/ggplot_pm25Timeseries.html">ggplot_pm25Timeseries()</a></code> function from the <strong>AirMonitorPlots</strong> package. Monitor PM 2.5 readings are subset by the start/end date parameters, then drawn onto two visualizations:</p>
<ol style="list-style-type: decimal">
<li><p>The first plots PM 2.5 readings separated by model and colored by model run, and</p></li>
<li><p>The second plots PM 2.5 readings separated by model run and colored by model:</p></li>
</ol>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># TODO:  Reset "eval = TRUE" when this starts working for Jon</span>
<span class="co"># Create a single ws_monitor object</span>
<span class="va">fakeMonitors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_combine.html">monitor_combine</a></span><span class="op">(</span><span class="va">fakeMonitorList</span><span class="op">)</span>
<span class="va">fakeAverages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_combine.html">monitor_combine</a></span><span class="op">(</span><span class="va">fakeAverageList</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/MazamaScience/AirMonitorPlots">AirMonitorPlots</a></span><span class="op">)</span>

<span class="va">tlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">startdate</span>, <span class="va">enddate</span><span class="op">)</span>

<span class="va">monitor_subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_subset.html">monitor_subset</a></span><span class="op">(</span><span class="va">fakeMonitors</span>, tlim <span class="op">=</span> <span class="va">tlim</span><span class="op">)</span>

<span class="va">ggByModel</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/AirMonitorPlots/man/ggplot_pm25Timeseries.html">ggplot_pm25Timeseries</a></span><span class="op">(</span>
    <span class="va">monitor_subset</span>,
    ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">monitor_subset</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
    includeFullEnddate <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/AirMonitorPlots/man/geom_pm25Points.html">geom_pm25Points</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">modelRun</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">.5</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/AirMonitorPlots/man/stat_nowcast.html">stat_nowcast</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">modelRun</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/AirMonitorPlots/man/stat_meanByHour.html">stat_meanByHour</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">modelRun</span><span class="op">)</span>, geom <span class="op">=</span> <span class="st">"line"</span>, size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"By Model (colored by model run)"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ggByModel</span><span class="op">)</span>

<span class="va">tlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">startdate</span>, <span class="va">enddate</span><span class="op">)</span>

<span class="va">monitor_subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PWFSLSmoke/man/monitor_subset.html">monitor_subset</a></span><span class="op">(</span><span class="va">fakeMonitors</span>, tlim <span class="op">=</span> <span class="va">tlim</span><span class="op">)</span>

<span class="va">ggByRun</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/AirMonitorPlots/man/ggplot_pm25Timeseries.html">ggplot_pm25Timeseries</a></span><span class="op">(</span>
    <span class="va">monitor_subset</span>,
    ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">monitor_subset</span><span class="op">$</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,
    includeFullEnddate <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/AirMonitorPlots/man/geom_pm25Points.html">geom_pm25Points</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">model</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">.5</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/AirMonitorPlots/man/stat_nowcast.html">stat_nowcast</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">model</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/AirMonitorPlots/man/stat_meanByHour.html">stat_meanByHour</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">model</span><span class="op">)</span>, geom <span class="op">=</span> <span class="st">"line"</span>, size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">modelRun</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"By Model Run (colored by model)"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ggByRun</span><span class="op">)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jonathan Callahan, Tate Brasel, Hans Martin, Rohan Aras, Zach Dingels, Jimin Kim, Jon Hagg, Rex Thompson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
