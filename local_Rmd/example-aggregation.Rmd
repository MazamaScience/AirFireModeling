---
title: "Blue Sky Aggregation"
author: "Hans Martin"
date: "10/23/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Bluesky Aggregation

Bluesky air-quality models by default generate new models for each day. That means for each $N$ days we decide to obtain data for, there will be $N$ independent models generated. For example, if we wanted to preform an analysis on _two_ days of data we would obtain a total of _two_ seperate models, or `chunks`, produced - each model looking $N$ days in advanced. 

To demonstrate this we will use the `blueksy_aggregate()` function  model of Oregon during the Granite Gulch fire (~5,500 acres), started by lightning on approximately the evening of Jul. 28, 2019. We will inspect models from Aug.8 - Aug. 10, 2019 to view one of the worst air-quality time frames caused by the fire.

#### Preparing our enviroment
We can begin by importing the necessary libraries and loading the required data.
```{r}
library(AirFireModeling)
library(MazamaSpatialUtils)

setSpatialDataDir("~/Data/Spatial")
setModelDataDir("~/Data/Bluesky")
loadSpatialData("NaturalEarthAdm1")
loadSpatialData('USCensusCounties')
```
#### Bounding regions
To avoid loading excessive data, we'll focus on a the counties near the source as they likely exhibit greatest affected air-quality - in this case it'll be Union and Baker County. 

We can obtain a bounding box region of the counties with the greatest affected air quality in Oregon by using the `USCensusCounties` dataset and the `bbox()` function. 
```{r}
# Subset Baker, Wallowa, and Union counties
bu <- subset(USCensusCounties, stateCode == 'OR' & countyName == c('Union', 'Baker'), )

# Find the regions bounding box
bu_bb <- bbox(bu)
```

#### Chunks
By default the first chunk is returned. The first chunk was _generated_ on Aug. 8, 2019 and models two days, to Aug. 11 2019.
```{r}
# Chunk 1
gran_gulch1 <- bluesky_aggregate( model = 'PNW-4km', 
                                  firstModelRun = 20190808, 
                                  lastModelRun = 20190810, 
                                  xlim = bu_bb[1,], 
                                  ylim = bu_bb[2,] ) 
# Plot the chunk aggregated 
grid_map(gran_gulch1)
```

We can access the second chunk by using `chunk = 2`, to view the model produced on the second day, Aug. 9, 2019. Just as before, the second day chunk models two days, to Aug. 12, 2019.    
```{r}
# Chunk 2
gran_gulch2 <- bluesky_aggregate( model = 'PNW-4km', 
                                  firstModelRun = 20190808, 
                                  lastModelRun = 20190810, 
                                  xlim = bu_bb[1,], 
                                  ylim = bu_bb[2,],
                                  chunk = 2 ) 
grid_map(gran_gulch2)
```

As demonstrated, the `bluesky_aggregate()` function allows us to bind together models generated over a period of time. Each model produced daily can be accessed by specifying the `chunk` parameter. We can inspect our `chunks` further by plotting them on a time axis to better understand, rather than the above combined spatial timeseries. 

We will make a function called `chunkPlot()` that accepts the first date of the first model we wish to obtain, the second model we wish to obtain and the regions bounded box. The function will collapse the Bluesky data into a `ws_object` monitor, cenetered about the mean location of the data, to use with timeseries plotting in the PWFSLSmoke Package. 

```{r}
chunkPlot <- function(firstModelRun, lastModelRun, bbox) {
  timeAxis <- seq(
    MazamaCoreUtils::parseDatetime(firstModelRun, timezone = "UTC"),
    MazamaCoreUtils::parseDatetime(lastModelRun + 3, timezone = "UTC"),
    by = "hour"
  )
  plot(timeAxis, seq_along(timeAxis), las = 1,
       col = "transparent", ylim = c(0,100))
  for ( modelRun in firstModelRun:lastModelRun ) {
    # Now add the full model time axis
    bluesky_load(
      model = "PNW-4km",
      modelRun = modelRun,
      subDir = "combined",
      xlim = bbox[1,],
      ylim = bbox[2,]
    ) %>%
      grid_createMonitor(
        longitude = rowMeans(bbox)[1],
        latitude = rowMeans(bbox)[2],
        radius = 10000,
        monitorID = "Model data",
        FUN = quantile,
        probs = 0.90,
        na.rm = TRUE
      ) %>%
      PWFSLSmoke::monitor_timeseriesPlot(
        type='l', 
        cex=0.5, 
        pch=15, 
        col = modelRun, 
        add = TRUE
      )
  }
}
```

Just as above, we want to look at our two seperate models produced on Aug. 8, 2019 and Aug. 9.  2019. both of which view three days in advanced. 

```{r}
chunkPlot(20190808, 20190809, bbox = bu_bb)
```

As we can see, each `chunk` models three days in advanced. Notice the overlap of models between Friday and Saturday - this will be an important aspect to recall when working with Bluesky model data. 

-- Mazama Science
